import { Component, computed, inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { wellDataStore } from '../../../core/stores/wwell-data/wwell-data.store';
import { MorningReportStore } from '../../../core/stores/moringreport/morning-report.store';

@Component({
  selector: 'app-misc-pres-well-data',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './misc-pres-well-data.component.html',
  styleUrl: './misc-pres-well-data.component.scss'
})
export class MiscPresWellDataComponent implements OnInit {
  // Inject both stores
  private readonly wellStore = inject(wellDataStore);
  private readonly reportStore = inject(MorningReportStore);

  /**
   * Selection Logic:
   * Finds the specific well data object where the epANum matches 
   * the ID selected in the chip list.
   */
  readonly selectedWellData = computed(() => {
    const selectedId = this.reportStore.selectedWellId();
    const allData = this.wellStore.response()?.data;

    if (!selectedId || !allData) {
      return null;
    }

    // Use .find to get the specific well matching the epANum
    // We cast to string to ensure safe comparison
    return allData.find(well => 
      String(well.DRLG_OP_STATUS?.[0]?.epANum) === String(selectedId)
    ) ?? null;
  });

  ngOnInit(): void {
    // Only load if data hasn't been fetched yet to avoid redundant API calls
    if (!this.wellStore.response()) {
      this.wellStore.loadWellData();
    }
  }

  refreshWelldata(): void {
    this.wellStore.refresh();
  }
}

@if (selectedWellData(); as data) {
  <div class="grid grid-cols-3 gap-3">
    <div class="col-span-2 bg-gradient-cyan-blue p-3 rounded-2xl text-white shadow-sm hover:shadow-xl transition-shadow duration-300">
      <div class="text-[10px] opacity-80 mb-1">Well Name</div>
      <div class="font-bold text-sm leading-tight">
        {{ data.RIG_ACTIVITY[0]?.wellName }} / {{ data.RIG_ACTIVITY[0]?.wRigCd }}
      </div>
      <div class="text-[10px] opacity-80">{{ data.RIG_ACTIVITY[0]?.welltype }}</div>
    </div>

    <div class="col-span-1 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
      <div class="text-[10px] text-slate-500 mb-1">Targeted Aquifer</div>
      <div class="font-bold text-blue-800 flex items-center gap-1">
        <i class="fa-solid fa-droplet text-blue-500"></i> 
        {{ data.EXAD_GWD_IR_HYDROGEOLOGY[0]?.estTargetAquifier }}
      </div>
    </div>

    <div class="col-span-2 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
      <div class="overflow-hidden">
        <div class="text-[10px] text-slate-500 mb-1">Current Status</div>
        <div class="font-bold text-blue-800 truncate text-xs" [title]="data.DRLG_OP_STATUS[0]?.wOpRmk">
          {{ data.DRLG_OP_STATUS[0]?.wOpRmk }}
        </div>
      </div>
      <div class="bg-gradient-cyan-blue p-2 rounded-full text-white shrink-0">
        <i class="fa-solid fa-gear animate-spin-slow"></i>
      </div>
    </div>

    <div class="col-span-1 bg-gradient-blue-dark p-3 rounded-2xl text-white shadow-sm">
      <div class="flex items-center gap-2 mb-1">
        <i class="fa-regular fa-calendar text-cyan-300"></i>
        <div class="text-[10px] opacity-80">Days</div>
      </div>
      <div class="font-bold text-sm">
        {{ data.DRLG_OP_STATUS[0]?.spuddays }}/{{ data.NEW_TARGET_DAYS[0]?.targetDays }}
      </div>
    </div>

    <div class="col-span-2 bg-gradient-blue-dark p-3 rounded-2xl text-white flex items-center justify-between relative overflow-hidden">
      <div>
        <div class="font-extrabold text-2xl">{{ data.DRLG_OP_STATUS[0]?.targetDepth | number }}</div>
        <div class="text-[10px] opacity-80">Feet (Target)</div>
      </div>
      <i class="fa-solid fa-water text-cyan-300 opacity-30 absolute right-2 bottom-0 text-4xl"></i>
    </div>

    <div class="col-span-1 bg-gradient-cyan-blue p-3 rounded-2xl text-white flex flex-col justify-center">
      <div class="text-[10px] opacity-80 mb-1">Depth (FT.DF)</div>
      <div class="font-bold text-lg">{{ data.DRLG_OP_STATUS[0]?.wPrsntDpth }}</div>
    </div>
  </div>
} @else {
  <div class="flex flex-col items-center justify-center p-8 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200">
    <div class="text-slate-400 mb-2">
      <i class="fa-solid fa-magnifying-glass-chart text-3xl"></i>
    </div>
    <p class="text-slate-500 text-sm">Please select a well from the list to view details</p>
  </div>
}
