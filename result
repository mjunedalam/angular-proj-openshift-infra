import { Component, computed, inject, effect } from '@angular/core';
import { wellDataStore } from '../../../core/stores/wwell-data/wwell-data.store';
import { MorningReportStore } from '../../../core/stores/moringreport/morning-report.store';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-misc-pres-well-data',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './misc-pres-well-data.component.html',
  styleUrl: './misc-pres-well-data.component.scss'
})
export class MiscPresWellDataComponent {
  private readonly reportStore = inject(MorningReportStore);
  private readonly wellStore = inject(wellDataStore);

  // Computed signal to extract the specific well data from the response
  readonly selectedWellData = computed(() => {
    const activeId = this.reportStore.selectedWellId();
    const responseData = this.wellStore.response()?.data;

    if (!responseData || !activeId) return null;

    // find returns the first match or undefined
    return responseData.find(item => 
      String(item.DRLG_OP_STATUS?.[0]?.epANum) === String(activeId)
    ) ?? null;
  });

  constructor() {
    // This effect acts as the "glue". Whenever selectedWellId changes, 
    // it triggers the API load in the other store.
    effect(() => {
      const id = this.reportStore.selectedWellId();
      if (id) {
        console.log('Flow Step 2: Selection change detected. Fetching data for:', id);
        this.wellStore.loadWellData(id);
      }
    });
  }
}
