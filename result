import { Component, computed, inject, effect } from '@angular/core';
import { wellDataStore } from '../../../core/stores/wwell-data/wwell-data.store';
import { MorningReportStore } from '../../../core/stores/moringreport/morning-report.store';
import { CommonModule } from '@angular/common';

// The strict View Model so our template is 100% safe
export interface WellDataViewModel {
  wellName: string;
  wellType: string;
  targetedAquifer: string;
  currentStatus: string;
  daysSinceSpud: number;
  targetDays: number;
  biNum: string;
  waterWell: string;
  footage: number;
  previousWell: string;
  currentDepth: number;
  nextWell: string;
}

@Component({
  selector: 'app-misc-pres-well-data',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './misc-pres-well-data.component.html',
  styleUrl: './misc-pres-well-data.component.scss'
})
export class MiscPresWellDataComponent {
  private readonly reportStore = inject(MorningReportStore);
  public readonly wellStore = inject(wellDataStore);

  // Safely map the raw data using optional chaining here (allowed in TS)
  readonly selectedWellData = computed<WellDataViewModel | null>(() => {
    const responseData = this.wellStore.response()?.data;
    if (!responseData) return null;

    const raw = Array.isArray(responseData) ? responseData[0] : responseData;
    if (!raw) return null;

    return {
      wellName: raw.RIG_ACTIVITY?.[0]?.wellName || 'N/A',
      wellType: raw.RIG_ACTIVITY?.[0]?.welltype || 'N/A',
      targetedAquifer: raw.EXAD_GWD_IR_HYDROGEOLOGY?.[0]?.estTargetAquifier || raw.EXAD_RCD_PREWAP?.[0]?.targetFormation || 'N/A',
      currentStatus: raw.DRLG_OP_STATUS?.[0]?.nxt24HrPlanRmk || 'Active',
      daysSinceSpud: raw.DRLG_OP_STATUS?.[0]?.spuddays ?? 0,
      targetDays: raw.NEW_TARGET_DAYS?.[0]?.targetDays ?? 0,
      biNum: raw.RIG_ACTIVITY?.[0]?.biNum || 'N/A',
      waterWell: raw.RIG_ACTIVITY?.[0]?.waterWell || 'N/A',
      footage: raw.DRLG_OP_STATUS?.[0]?.footage ?? 0,
      previousWell: raw.EXAD_GWD_IR_WATER?.[0]?.offsetWaterWell || 'N/A',
      currentDepth: raw.DRLG_OP_STATUS?.[0]?.wPrsntDpth ?? 0,
      nextWell: raw.NEXT_2_WELL_ACTIVITY?.[0]?.nextWellActivity || 'N/A',
    };
  });

  constructor() {
    // Reverted back to using effect() to listen for ID changes
    effect(() => {
      const id = this.reportStore.selectedWellId();
      if (id) {
        console.log('Selection change detected. Fetching data for:', id);
        this.wellStore.loadWellData(id);
      }
    });
  }
}
====
@if (selectedWellData(); as wellData) {
<div class="relative transition-opacity duration-300" 
     [class.opacity-50]="wellStore.isLoading()" 
     [class.pointer-events-none]="wellStore.isLoading()">
  
  @if (wellStore.isLoading()) {
    <div class="absolute inset-0 z-10 flex items-center justify-center">
      <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 drop-shadow-md"></i>
    </div>
  }

  <div class="grid grid-cols-3 gap-3">
    
    <div class="col-span-2 bg-gradient-cyan-blue p-3 rounded-2xl text-white shadow-sm overflow-hidden hover:shadow-xl transition-shadow duration-300 animate-pulse-shadow">
      <div class="text-[10px] opacity-80 mb-1">Well Name</div>
      <div class="font-bold text-sm leading-tight">{{ wellData.wellName }}</div>
      <div class="text-[10px] opacity-80">{{ wellData.wellType }}</div>
    </div>

    <div class="col-span-1 bg-white p-3 rounded-2xl shadow-sm flex flex-col justify-center border border-slate-100 hover:shadow-xl transition-shadow duration-300">
      <div class="text-[10px] text-slate-500 mb-1">Targeted Aquifer</div>
      <div class="font-bold text-blue-800 flex items-center gap-1">
        <i class="fa-solid fa-droplet text-blue-500"></i> 
        {{ wellData.targetedAquifer }}
      </div>
    </div>

    <div class="col-span-2 bg-white p-3 rounded-2xl shadow-sm flex items-center justify-between border border-slate-100 hover:shadow-xl transition-shadow duration-300">
      <div class="flex-1 min-w-0 pr-2">
        <div class="text-[10px] text-slate-500 mb-1">Current Status</div>
        <div class="font-bold text-blue-800 text-xs truncate" [title]="wellData.currentStatus">
          {{ wellData.currentStatus }}
        </div>
      </div>
      <div class="bg-gradient-cyan-blue p-2 rounded-full text-white shadow-sm animate-pulse flex-shrink-0">
        <i class="fa-solid fa-gear animate-spin-slow"></i>
      </div>
    </div>

    <div class="col-span-1 bg-gradient-blue-dark p-3 rounded-2xl text-white shadow-sm flex flex-col justify-center hover:shadow-xl transition-shadow duration-300">
      <div class="flex items-center gap-2 mb-1">
        <i class="fa-regular fa-calendar text-cyan-300"></i>
        <div class="text-[10px] opacity-80">Days</div>
      </div>
      <div class="font-bold text-sm">
        {{ wellData.daysSinceSpud }} / {{ wellData.targetDays }}
      </div>
    </div>

    <div class="col-span-2 grid grid-cols-2 gap-3 bg-white p-3 rounded-2xl shadow-sm border border-slate-100 hover:shadow-xl transition-shadow duration-300">
      <div class="text-center">
        <div class="text-[10px] text-slate-500 mb-1">Days since Spud</div>
        <div class="w-12 h-12 rounded-full border-4 border-slate-100 border-t-cyan-500 border-r-blue-500 mx-auto flex items-center justify-center shadow-sm bg-white">
          <span class="text-base font-extrabold text-blue-900">{{ wellData.daysSinceSpud }}</span>
        </div>
      </div>
      <div class="text-center">
        <div class="text-[10px] text-slate-500 mb-1">Target Days</div>
        <div class="w-12 h-12 rounded-full border-4 border-slate-100 border-t-blue-300 mx-auto flex items-center justify-center shadow-sm bg-white">
          <span class="text-base font-extrabold text-blue-900">{{ wellData.targetDays }}</span>
        </div>
      </div>
    </div>

    <div class="col-span-1 bg-gradient-cyan-blue p-3 rounded-2xl text-white shadow-sm flex flex-col justify-center hover:shadow-xl transition-shadow duration-300">
      <div class="font-bold text-lg leading-none mb-1">BI-{{ wellData.biNum }}</div>
      <div class="text-[10px] opacity-80">Supporting</div>
      <div class="font-bold text-xs truncate" [title]="wellData.waterWell">
        {{ wellData.waterWell }}
      </div>
    </div>

    <div class="col-span-2 bg-gradient-blue-dark p-3 rounded-2xl text-white shadow-sm flex items-center justify-between relative overflow-hidden hover:shadow-xl transition-shadow duration-300">
      <div>
        <div class="font-extrabold text-2xl">{{ wellData.footage | number }}</div>
        <div class="text-[10px] opacity-80">Feet Drilled Today</div>
      </div>
      <div class="text-cyan-300 opacity-50 absolute right-2 bottom-0 text-4xl">
        <i class="fa-solid fa-water"></i>
      </div>
      <div class="text-white absolute top-2 right-1/3">
        <i class="fa-solid fa-arrow-down"></i>
      </div>
    </div>

    <div class="col-span-1 bg-gradient-cyan-blue p-3 rounded-2xl text-white shadow-sm flex flex-col justify-center hover:shadow-xl transition-shadow duration-300">
      <div class="text-[10px] opacity-80 mb-1">Previous Well</div>
      <div class="font-bold text-sm truncate" [title]="wellData.previousWell">
        {{ wellData.previousWell }}
      </div>
    </div>

    <div class="col-span-2 bg-gradient-cyan-blue p-3 rounded-2xl text-white shadow-sm flex items-center justify-between hover:shadow-xl transition-shadow duration-300">
      <div class="text-[10px] opacity-80 font-medium">Current Depth (FT.DF)</div>
      <div class="font-extrabold text-2xl">{{ wellData.currentDepth | number }}</div>
    </div>

    <div class="col-span-1 bg-gradient-blue-dark p-3 rounded-2xl text-white shadow-sm flex flex-col justify-center hover:shadow-xl transition-shadow duration-300">
      <div class="text-[10px] opacity-80 mb-1">Next Well</div>
      <div class="font-bold text-sm truncate" [title]="wellData.nextWell">
        {{ wellData.nextWell }}
      </div>
    </div>

  </div>
</div>
} @else {
  <div class="flex items-center justify-center p-12 text-slate-400 bg-slate-50 rounded-2xl border border-slate-100">
    <i class="fa-solid fa-circle-notch fa-spin text-2xl mr-3 text-blue-500"></i> 
    <span class="text-sm font-medium">Loading Initial Well Data...</span>
  </div>
}
