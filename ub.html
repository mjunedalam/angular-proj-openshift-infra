import { Component, signal, computed, ViewEncapsulation, inject, EffectRef, effect } from '@angular/core';
import { CommonModule } from '@angular/common';
import { DomSanitizer, SafeUrl, SafeResourceUrl } from '@angular/platform-browser';

// Interface for our File object wrapper
interface FileItem {
  id: string;
  file: File;
  name: string;
  size: string;
  type: string;
  url: SafeUrl; // For Image preview
  resourceUrl?: SafeResourceUrl; // For PDF preview
  rawUrl: string; // For cleanup
  isImage: boolean;
  isPdf: boolean;
  isYaml: boolean;
  textContent?: string; // For YAML content preview
}

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule],
  encapsulation: ViewEncapsulation.None,
  template: `
    <div class="min-h-screen bg-slate-50 text-slate-800 font-sans p-4 md:p-8 selection:bg-indigo-100">
      
      <!-- Main Container -->
      <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="text-center space-y-2">
          <h1 class="text-3xl md:text-4xl font-bold text-slate-900 tracking-tight">File Uploader</h1>
          <p class="text-slate-500">Upload documents, images, and configuration files.</p>
        </div>

        <!-- Upload Zone -->
        <div 
          class="relative group cursor-pointer"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <!-- Background & Border Animation -->
          <div 
            class="absolute inset-0 bg-white rounded-2xl transition-all duration-300 ease-out"
            [class.shadow-xl]="isDragging()"
            [class.shadow-sm]="!isDragging()"
            [class.ring-2]="isDragging()"
            [class.ring-indigo-500]="isDragging()"
            [class.ring-offset-2]="isDragging()"
          ></div>
          
          <div 
            class="relative border-2 border-dashed rounded-2xl h-64 flex flex-col items-center justify-center transition-colors duration-300"
            [class.border-indigo-500]="isDragging()"
            [class.bg-indigo-50]="isDragging()"
            [class.border-slate-300]="!isDragging()"
            [class.group-hover:border-indigo-400]="!isDragging()"
            [class.group-hover:bg-slate-50]="!isDragging()"
          >
            
            <!-- Icon -->
            <div class="mb-4 p-4 bg-indigo-100 text-indigo-600 rounded-full transition-transform duration-300 group-hover:scale-110">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>

            <p class="text-lg font-medium text-slate-700">
              <span class="text-indigo-600">Click to upload</span> or drag and drop
            </p>
            <p class="text-sm text-slate-400 mt-1">PNG, JPG, PDF or YAML (max 10MB)</p>
          </div>

          <input 
            #fileInput 
            type="file" 
            multiple
            accept=".png,.jpeg,.jpg,.pdf,.yaml,.yml"
            class="hidden" 
            (change)="onFileSelected($event)"
          >
        </div>

        <!-- Stats -->
        @if (files().length > 0) {
          <div class="flex items-center justify-between text-sm text-slate-500 px-1">
            <span>{{ files().length }} file{{ files().length === 1 ? '' : 's' }} selected</span>
            <button (click)="clearAll()" class="text-red-500 hover:text-red-700 font-medium transition-colors">
              Clear all
            </button>
          </div>
        }

        <!-- File List Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          @for (file of files(); track file.id) {
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex items-center gap-4 transition-all hover:shadow-md hover:border-indigo-100 group animate-in fade-in slide-in-from-bottom-2 duration-300">
              
              <!-- Thumbnail / Icon -->
              <div class="relative w-16 h-16 shrink-0 bg-slate-100 rounded-lg overflow-hidden border border-slate-200 flex items-center justify-center text-slate-400">
                @if (file.isImage) {
                  <img [src]="file.url" class="w-full h-full object-cover" alt="Preview">
                } @else if (file.isPdf) {
                    <!-- PDF Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg>
                } @else if (file.isYaml) {
                    <!-- Code/YAML Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><polyline points="16 13 12 17 8 13"/></svg>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                }
              </div>

              <!-- Info -->
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-slate-900 truncate" title="{{file.name}}">{{ file.name }}</h4>
                <p class="text-xs text-slate-500 mt-0.5">{{ file.size }} â€¢ {{ file.isYaml ? 'YAML' : (file.type || 'Unknown') }}</p>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-1">
                <button 
                  (click)="openPreview(file)"
                  class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors"
                  title="Preview"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <button 
                  (click)="removeFile(file.id)"
                  class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"
                  title="Remove"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Preview Modal -->
      @if (selectedFile()) {
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
          <!-- Backdrop -->
          <div 
            class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
            (click)="closePreview()"
          ></div>

          <!-- Modal Content -->
          <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200">
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-white z-10">
              <div class="flex items-center gap-3 overflow-hidden">
                <span class="p-2 bg-indigo-50 text-indigo-600 rounded-lg shrink-0">
                    @if(selectedFile()?.isImage) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    } @else if(selectedFile()?.isPdf) {
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15h6"/></svg>
                    } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    }
                </span>
                <div class="min-w-0">
                    <h3 class="font-semibold text-lg text-slate-800 truncate" title="{{selectedFile()?.name}}">{{ selectedFile()?.name }}</h3>
                    <p class="text-xs text-slate-500">{{ selectedFile()?.size }}</p>
                </div>
              </div>
              
              <button 
                (click)="closePreview()"
                class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors ml-4"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-auto bg-slate-50 flex flex-col items-center justify-center p-4 relative">
              
              @if (selectedFile()?.isImage) {
                <!-- Image Preview -->
                <img [src]="selectedFile()?.url" class="max-w-full max-h-[75vh] object-contain shadow-sm rounded-lg" alt="Full Preview">
              
              } @else if (selectedFile()?.isPdf) {
                <!-- PDF Preview -->
                <iframe 
                    [src]="selectedFile()?.resourceUrl" 
                    class="w-full h-[75vh] bg-white rounded-lg shadow-sm border border-slate-200"
                    title="PDF Preview"
                ></iframe>

              } @else if (selectedFile()?.isYaml) {
                <!-- YAML Preview -->
                <div class="w-full h-full max-h-[75vh] bg-slate-900 rounded-lg shadow-lg overflow-hidden flex flex-col">
                    <div class="bg-slate-800 px-4 py-2 text-xs text-slate-400 font-mono border-b border-slate-700 flex justify-between">
                        <span>YAML SOURCE</span>
                        <span>READ-ONLY</span>
                    </div>
                    <div class="overflow-auto p-6">
                        @if (selectedFile()?.textContent) {
                            <pre class="font-mono text-sm text-emerald-400 whitespace-pre leading-relaxed">{{ selectedFile()?.textContent }}</pre>
                        } @else {
                            <div class="flex items-center justify-center h-40 text-slate-500">
                                <span class="animate-pulse">Loading content...</span>
                            </div>
                        }
                    </div>
                </div>

              } @else {
                <!-- Fallback -->
                <div class="flex flex-col items-center justify-center p-8 text-center">
                  <div class="w-20 h-20 bg-slate-100 text-slate-400 rounded-2xl flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                  </div>
                  <p class="text-slate-900 font-medium text-lg">Preview not available</p>
                  <p class="text-slate-500 mt-1 mb-6 max-w-xs">
                    This file type cannot be previewed directly.
                  </p>
                </div>
              }
            </div>

          </div>
        </div>
      }

    </div>
  `
})
export class App {
  private sanitizer = inject(DomSanitizer);

  // Signals for state management
  files = signal<FileItem[]>([]);
  isDragging = signal<boolean>(false);
  selectedFile = signal<FileItem | null>(null);

  constructor() {
    // Cleanup effect
    effect(() => {
      // In a real app we might track and revoke older URLs here if needed
    });
  }

  onDragOver(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    this.isDragging.set(true);
  }

  onDragLeave(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    if ((event.relatedTarget as HTMLElement)?.closest('.group') !== event.target) {
        this.isDragging.set(false);
    }
  }

  onDrop(event: DragEvent) {
    event.preventDefault();
    event.stopPropagation();
    this.isDragging.set(false);

    const droppedFiles = event.dataTransfer?.files;
    if (droppedFiles) {
      this.handleFiles(droppedFiles);
    }
  }

  onFileSelected(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input.files) {
      this.handleFiles(input.files);
      input.value = '';
    }
  }

  handleFiles(fileList: FileList) {
    const newFiles: FileItem[] = [];

    Array.from(fileList).forEach(file => {
      const exists = this.files().some(f => f.name === file.name && f.size === this.formatSize(file.size));
      if (!exists) {
        const rawUrl = URL.createObjectURL(file);
        
        // Determine types
        const isImage = file.type.startsWith('image/');
        const isPdf = file.type === 'application/pdf';
        // Basic check for yaml/yml extensions as MIME types can vary
        const isYaml = file.name.toLowerCase().endsWith('.yaml') || file.name.toLowerCase().endsWith('.yml');

        const newItem: FileItem = {
          id: crypto.randomUUID(),
          file,
          name: file.name,
          size: this.formatSize(file.size),
          type: file.type,
          rawUrl: rawUrl,
          url: this.sanitizer.bypassSecurityTrustUrl(rawUrl),
          resourceUrl: isPdf ? this.sanitizer.bypassSecurityTrustResourceUrl(rawUrl) : undefined,
          isImage,
          isPdf,
          isYaml,
          textContent: undefined
        };

        // If YAML, read text content for preview
        if (isYaml) {
            file.text().then(text => {
                this.files.update(current => 
                    current.map(f => f.id === newItem.id ? { ...f, textContent: text } : f)
                );
            }).catch(err => console.error('Error reading YAML', err));
        }

        newFiles.push(newItem);
      }
    });

    this.files.update(current => [...current, ...newFiles]);
  }

  removeFile(id: string) {
    const fileToRemove = this.files().find(f => f.id === id);
    if (fileToRemove) {
      URL.revokeObjectURL(fileToRemove.rawUrl);
      this.files.update(current => current.filter(f => f.id !== id));
      
      if (this.selectedFile()?.id === id) {
        this.closePreview();
      }
    }
  }

  clearAll() {
    this.files().forEach(f => URL.revokeObjectURL(f.rawUrl));
    this.files.set([]);
    this.closePreview();
  }

  openPreview(file: FileItem) {
    this.selectedFile.set(file);
  }

  closePreview() {
    this.selectedFile.set(null);
  }

  formatSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
}